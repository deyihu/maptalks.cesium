/*!
 * maptalks.cesium v0.0.0
 * LICENSE : MIT
 * (c) 2016-2020 maptalks.org
 */
/*!
 * requires maptalks@<2.0.0 
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks"),require("Cesium")):"function"==typeof define&&define.amd?define(["exports","maptalks","Cesium"],t):t(e.maptalks=e.maptalks||{},e.maptalks,e.Cesium)}(this,function(e,c,f){"use strict";var t={getCenter:function(){return null},getMap:function(){var e=this._layer;return e?e.getMap():null},setInfoWindow:function(e){return this.infoWindow=new c.ui.InfoWindow(e),this},getInfoWindow:function(){return this.infoWindow},openInfoWindow:function(e){return e&&this.infoWindow&&this.infoWindow.show(e),this},closeInfoWindow:function(){return this.infoWindow&&this.infoWindow.hide(),this},removeInfoWindow:function(){return this.infoWindow&&this.infoWindow.remove()&&delete this.infoWindow,this},setToolTip:function(e,t){return this.toolTip=new c.ui.ToolTip(e,t),this},getToolTip:function(){return this.toolTip},openToolTip:function(e){return e&&this.toolTip&&this.toolTip.show(e),this},closeToolTip:function(){return this.toolTip&&this.toolTip.hide(),this},removeToolTip:function(){return this.toolTip&&this.toolTip.remove()&&delete this.toolTip,this}};function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):function(e,t){for(var n=Object.getOwnPropertyNames(t),i=0;i<n.length;i++){var o=n[i],r=Object.getOwnPropertyDescriptor(t,o);r&&r.configurable&&void 0===e[o]&&Object.defineProperty(e,o,r)}}(e,t))}var i,o=(n(r,i=c.Eventable(f.Primitive)),r);function r(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,i.apply(this,arguments))}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):function(e,t){for(var n=Object.getOwnPropertyNames(t),i=0;i<n.length;i++){var o=n[i],r=Object.getOwnPropertyDescriptor(t,o);r&&r.configurable&&void 0===e[o]&&Object.defineProperty(e,o,r)}}(e,t))}c.Util.extend(o.prototype,t);var a,u=(s(p,a=c.Eventable(f.Cesium3DTileset)),p);function p(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,p),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,a.apply(this,arguments))}function h(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function d(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):function(e,t){for(var n=Object.getOwnPropertyNames(t),i=0;i<n.length;i++){var o=n[i],r=Object.getOwnPropertyDescriptor(t,o);r&&r.configurable&&void 0===e[o]&&Object.defineProperty(e,o,r)}}(e,t))}c.Util.extend(u.prototype,t);var v=["mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"];var y,m=(d(g,y=c.CanvasLayer),g.prototype.getCesiumScene=function(){var e=this._getRenderer();return e?e.scene:null},g.prototype.getCameraAltitude=function(){if(!this._getRenderer())return 0;var e=this.getCesiumScene().camera;return f.Ellipsoid.WGS84.cartesianToCartographic(e.position).height},g.prototype.redraw=function(){var e=this._getRenderer();return e?e.setToRedraw():null},g.prototype.identify=function(e,t){var n=this.getCesiumScene();if(!n)return[];if(!e)return console.error("coordinate is null,it should be Coordinate"),[];if(Array.isArray(e)&&(e=new c.Coordinate(e)),!(e instanceof c.Coordinate))return console.error("coordinate type is error,it should be Coordinate"),[];var i=this.getMap().coordToContainerPoint(e),o=i.x,r=i.y,s=n.pick(new f.Cartesian2(o,r));if(!s)return[];s=[s];var a=(t=c.Util.extend({},t)).count;return c.Util.isNumber(a)&&0<a?s.slice(0,a):s},g.prototype._identifyPrimitiveEvents=function(n){var i=this,e=this.map||this.getMap();e.resetCursor("default");var o,r=n.type,s=n.coordinate,a=this.identify(s).map(function(e){var t=e.primitive;for(var n in e)"primitive"!==n&&(t[n]=e[n]);return t});return a.length&&e.setCursor("pointer"),"mousemove"===r?(o=[],this.selectPrimitives&&this.selectPrimitives.forEach(function(t){var n=!0;a.forEach(function(e){t===e&&(n=!1)}),n&&o.push(t)}),o.forEach(function(e){e._fire?(e._mouseover=!1,e._fire("mouseout",Object.assign({},n,{target:e,type:"mouseout"})),e.closeToolTip&&e.closeToolTip()):i.onSelect&&i.onSelect(Object.assign({},n,{target:e,type:"mouseout"}))}),a.forEach(function(e){var t;e._fire?(e._mouseover||(e._fire("mouseover",Object.assign({},n,{target:e,type:"mouseover"})),e._mouseover=!0),e._fire(r,Object.assign({},n,{target:e})),e.getToolTip&&((t=e.getToolTip())&&!t._owner&&t.addTo(e),e.openToolTip(s))):i.onSelect&&(e._mouseover||(i.onSelect(Object.assign({},n,{target:e,type:"mouseover"})),e._mouseover=!0),i.onSelect(Object.assign({},n,{target:e,type:r})))})):a.forEach(function(e){var t;e._fire?(e._fire(r,Object.assign({},n,{target:e})),"click"===r&&e.getInfoWindow&&((t=e.getInfoWindow())&&!t._owner&&t.addTo(e),e.openInfoWindow(s))):i.onSelect&&i.onSelect(Object.assign({},n,{target:e,type:r}))}),this.selectPrimitives=a,this},g.prototype.onAdd=function(){var t=this;y.prototype.onAdd.call(this);var n=this.map||this.getMap();return n&&(this.selectPrimitives=this.selectPrimitives||[],v.forEach(function(e){n.on(e,t._identifyPrimitiveEvents,t)})),this},g.prototype.onRemove=function(){var t=this;y.prototype.onRemove.call(this);var n=this.map||this.getMap();return n&&v.forEach(function(e){n.off(e,t._identifyPrimitiveEvents,t)}),this},g.prototype.addPrimitive=function(e){var t=this;Array.isArray(e)||(e=[e]);var n=this.getCesiumScene();return n&&e.forEach(function(e){e._layer=t,n.primitives.add(e)}),this},g.prototype.removePrimitive=function(e){Array.isArray(e)||(e=[e]);var t=this.getCesiumScene();return t&&e.forEach(function(e){t.primitives.remove(e)}),this},g);function g(){return h(this,g),l(this,y.apply(this,arguments))}m.mergeOptions({sceneOptions:null,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0});var w,b=new f.Color(0,0,0,0),O=(d(C,w=c.renderer.CanvasRenderer),C.prototype.needToRedraw=function(){return!0},C.prototype.onAdd=function(){this.prepareCanvas()},C.prototype._adjust=function(e){var t=this.canvas.height/2;return e.y+=(e.y-t)/t*20,e},C.prototype.draw=function(){this.prepareCanvas(),this._locateCamera(),this._renderCesiumScene(),this.completeRender()},C.prototype.drawOnInteracting=function(){this.prepareCanvas(),this._locateCamera(),this._renderCesiumScene(),this.completeRender()},C.prototype.createContext=function(){var e;document.createElement("div").appendChild(this.canvas),e=this.canvas,Object.defineProperty(e,"clientWidth",{get:function(){return e.width}}),Object.defineProperty(e,"clientHeight",{get:function(){return e.height}});var t=this.layer.options.sceneOptions||{},t=c.Util.extend(t,{canvas:this.canvas,scene3DOnly:!0,contextOptions:{webgl:{alpha:!0}}});this.scene=new f.Scene(t),this.scene.fog.enabled=!1,this.scene.backgroundColor=b,this.scene.camera.constrainedAxis=f.Cartesian3.UNIT_Z,this.globe=new f.Globe(f.Ellipsoid.WGS84),this.globe.baseColor=b,this.scene.globe=this.globe},C.prototype.clearCanvas=function(){this.canvas},C.prototype.resizeCanvas=function(e){w.prototype.resizeCanvas.call(this,e),this.canvas&&(this.scene.camera.frustum.aspectRatio=this.canvas.width/this.canvas.height)},C.prototype._sceneReady=function(){if(this.scene.terrainProvider&&!this.scene.terrainProvider.ready)return!1;if(this.scene.imageryLayers)for(var e=this.scene.imageryLayers,t=e.length,n=0;n<t;n++)if(!e.get(n).imageryProvider.ready)return!1;return!0},C.prototype._renderCesiumScene=function(){this.scene.initializeFrame(),this.scene.render(f.JulianDate.now())},C.prototype._locateCamera=function(){var e,t,n,i,o,r,s,a,c,u=this.getMap(),p=u.getCenter(),h=this.scene;p&&(t=u.getFov()*Math.PI/180,this.canvas.height<this.canvas.width&&(e=this.canvas.width/this.canvas.height,t=2*Math.atan(Math.tan(.5*t)*e)),h.camera.frustum.fov=t,n=p.toArray(),i=T(u.getPitch()),o=this._calcDistance(u),r=new f.Cartographic(T(n[0]),T(n[1])),h.globe&&(s=h.globe.getHeight(r),r.height=s||0),a=f.Ellipsoid.WGS84.cartographicToCartesian(r),c={pitch:i-Math.PI/2,heading:T(u.getBearing()),roll:void 0},h.camera.setView({destination:a,orientation:c}),h.camera.moveBackward(o))},C.prototype._calcDistance=function(e){var t=this.canvas,n=this.scene.camera.frustum.fov,i=e.getCenter(),o=e.locateByPoint(i,-t.width/2,0),r=e.locateByPoint(i,t.width/2,0);return e.computeLength(r,o)/2/Math.tan(n/2)},C);function C(){return h(this,C),l(this,w.apply(this,arguments))}function T(e){return e*Math.PI/180}m.registerRenderer("canvas",O),e.CesiumLayer=m,e.Primitive=o,e.Cesium3DTileset=u,Object.defineProperty(e,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.cesium v0.0.0, requires maptalks@<2.0.0.")});