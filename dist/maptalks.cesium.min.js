/*!
 * maptalks.cesium v0.0.0
 * LICENSE : MIT
 * (c) 2016-2021 maptalks.org
 */
/*!
 * requires maptalks@<2.0.0 
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks"),require("Cesium")):"function"==typeof define&&define.amd?define(["exports","maptalks","Cesium"],t):t(e.maptalks=e.maptalks||{},e.maptalks,e.Cesium)}(this,function(e,c,s){"use strict";var t={getCenter:function(){return null},getMap:function(){var e=this._layer;return e?e.getMap():null},setInfoWindow:function(e){return this.infoWindow=new c.ui.InfoWindow(e),this},getInfoWindow:function(){return this.infoWindow},openInfoWindow:function(e){return e&&this.infoWindow&&this.infoWindow.show(e),this},closeInfoWindow:function(){return this.infoWindow&&this.infoWindow.hide(),this},removeInfoWindow:function(){return this.infoWindow&&this.infoWindow.remove()&&delete this.infoWindow,this},setToolTip:function(e,t){return this.toolTip=new c.ui.ToolTip(e,t),this},getToolTip:function(){return this.toolTip},openToolTip:function(e){return e&&this.toolTip&&this.toolTip.show(e),this},closeToolTip:function(){return this.toolTip&&this.toolTip.hide(),this},removeToolTip:function(){return this.toolTip&&this.toolTip.remove()&&delete this.toolTip,this}};function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):function(e,t){for(var i=Object.getOwnPropertyNames(t),n=0;n<i.length;n++){var o=i[n],r=Object.getOwnPropertyDescriptor(t,o);r&&r.configurable&&void 0===e[o]&&Object.defineProperty(e,o,r)}}(e,t))}var n,o=(i(r,n=c.Eventable(s.Primitive)),r);function r(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,n.apply(this,arguments))}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):function(e,t){for(var i=Object.getOwnPropertyNames(t),n=0;n<i.length;n++){var o=i[n],r=Object.getOwnPropertyDescriptor(t,o);r&&r.configurable&&void 0===e[o]&&Object.defineProperty(e,o,r)}}(e,t))}c.Util.extend(o.prototype,t);var u,p=(a(h,u=c.Eventable(s.Cesium3DTileset)),h);function h(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,h),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,u.apply(this,arguments))}function f(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function d(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):function(e,t){for(var i=Object.getOwnPropertyNames(t),n=0;n<i.length;n++){var o=i[n],r=Object.getOwnPropertyDescriptor(t,o);r&&r.configurable&&void 0===e[o]&&Object.defineProperty(e,o,r)}}(e,t))}c.Util.extend(p.prototype,t);var v=["mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"];var m,y=(d(g,m=c.CanvasLayer),g.prototype.getCesiumScene=function(){var e=this._getRenderer();return e?e.scene:null},g.prototype.getCameraAltitude=function(){if(!this._getRenderer())return 0;var e=this.getCesiumScene().camera;return s.Ellipsoid.WGS84.cartesianToCartographic(e.position).height},g.prototype.redraw=function(){var e=this._getRenderer();return e?e.setToRedraw():null},g.prototype.identify=function(e,t){var i=this.getCesiumScene();if(!i)return[];if(!e)return console.error("coordinate is null,it should be Coordinate"),[];if(!((e=Array.isArray(e)?new c.Coordinate(e):e)instanceof c.Coordinate))return console.error("coordinate type is error,it should be Coordinate"),[];var n=this.getMap().coordToContainerPoint(e),e=n.x,n=n.y;if(!(n=i.pick(new s.Cartesian2(e,n))))return[];n=[n],t=(t=c.Util.extend({},t)).count;return c.Util.isNumber(t)&&0<t?n.slice(0,t):n},g.prototype._identifyPrimitiveEvents=function(i){var n=this;if(!this.options.geometryEvents)return this;var e=this.map||this.getMap(),o=i.type,r=i.coordinate,t=c.Util.now();if(this._mousemoveTimeOut&&"mousemove"===o&&t-this._mousemoveTimeOut<16)return this;this._mousemoveTimeOut=t,e.resetCursor("default");var s,a=this.identify(r).map(function(e){var t,i=e.primitive;for(t in e)"primitive"!==t&&(i[t]=e[t]);return i});return a.length&&e.setCursor("pointer"),"mousemove"===o?(s=[],this.selectPrimitives&&this.selectPrimitives.forEach(function(t){var i=!0;a.forEach(function(e){t===e&&(i=!1)}),i&&s.push(t)}),s.forEach(function(e){e._fire?(e._mouseover=!1,e._fire("mouseout",Object.assign({},i,{target:e,type:"mouseout"})),e.closeToolTip&&e.closeToolTip()):n.onSelect&&n.onSelect(Object.assign({},i,{target:e,type:"mouseout"}))}),a.forEach(function(e){var t;e._fire?(e._mouseover||(e._fire("mouseover",Object.assign({},i,{target:e,type:"mouseover"})),e._mouseover=!0),e._fire(o,Object.assign({},i,{target:e})),e.getToolTip&&((t=e.getToolTip())&&!t._owner&&t.addTo(e),e.openToolTip(r))):n.onSelect&&(e._mouseover||(n.onSelect(Object.assign({},i,{target:e,type:"mouseover"})),e._mouseover=!0),n.onSelect(Object.assign({},i,{target:e,type:o})))})):a.forEach(function(e){var t;e._fire?(e._fire(o,Object.assign({},i,{target:e})),"click"===o&&e.getInfoWindow&&((t=e.getInfoWindow())&&!t._owner&&t.addTo(e),e.openInfoWindow(r))):n.onSelect&&n.onSelect(Object.assign({},i,{target:e,type:o}))}),this.selectPrimitives=a,this},g.prototype.onAdd=function(){var t=this;m.prototype.onAdd.call(this);var i=this.map||this.getMap();return i&&(this.selectPrimitives=this.selectPrimitives||[],v.forEach(function(e){i.on(e,t._identifyPrimitiveEvents,t)})),this},g.prototype.onRemove=function(){var t=this;m.prototype.onRemove.call(this);var i=this.map||this.getMap();return i&&v.forEach(function(e){i.off(e,t._identifyPrimitiveEvents,t)}),this},g.prototype.addPrimitive=function(e){var t=this;Array.isArray(e)||(e=[e]);var i=this.getCesiumScene();return i&&e.forEach(function(e){e._layer=t,i.primitives.add(e)}),this},g.prototype.removePrimitive=function(e){Array.isArray(e)||(e=[e]);var t=this.getCesiumScene();return t&&e.forEach(function(e){t.primitives.remove(e)}),this},g);function g(){return f(this,g),l(this,m.apply(this,arguments))}y.mergeOptions({sceneOptions:null,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,geometryEvents:!1});var w,b=new s.Color(0,0,0,0),t=(d(O,w=c.renderer.CanvasRenderer),O.prototype.needToRedraw=function(){return!0},O.prototype.onAdd=function(){this.prepareCanvas()},O.prototype._adjust=function(e){var t=this.canvas.height/2;return e.y+=(e.y-t)/t*20,e},O.prototype.draw=function(){this.prepareCanvas(),this._locateCamera(),this._renderCesiumScene(),this.completeRender()},O.prototype.drawOnInteracting=function(){this.prepareCanvas(),this._locateCamera(),this._renderCesiumScene(),this.completeRender()},O.prototype.createContext=function(){var e;document.createElement("div").appendChild(this.canvas),e=this.canvas,Object.defineProperty(e,"clientWidth",{get:function(){return e.width}}),Object.defineProperty(e,"clientHeight",{get:function(){return e.height}});var t=this.layer.options.sceneOptions||{},t=c.Util.extend(t,{canvas:this.canvas,scene3DOnly:!0,contextOptions:{webgl:{alpha:!0}}});this.scene=new s.Scene(t),this.scene.fog.enabled=!1,this.scene.backgroundColor=b,this.scene.camera.constrainedAxis=s.Cartesian3.UNIT_Z,this.globe=new s.Globe(s.Ellipsoid.WGS84),this.globe.baseColor=b,this.scene.globe=this.globe},O.prototype.clearCanvas=function(){this.canvas},O.prototype.resizeCanvas=function(e){w.prototype.resizeCanvas.call(this,e),this.canvas&&(this.scene.camera.frustum.aspectRatio=this.canvas.width/this.canvas.height)},O.prototype._sceneReady=function(){if(this.scene.terrainProvider&&!this.scene.terrainProvider.ready)return!1;if(this.scene.imageryLayers)for(var e=this.scene.imageryLayers,t=e.length,i=0;i<t;i++)if(!e.get(i).imageryProvider.ready)return!1;return!0},O.prototype._renderCesiumScene=function(){this.scene.initializeFrame(),this.scene.render(s.JulianDate.now())},O.prototype._locateCamera=function(){var e,t,i,n=this.getMap(),o=n.getCenter(),r=this.scene;o&&(t=n.getFov()*Math.PI/180,this.canvas.height<this.canvas.width&&(e=this.canvas.width/this.canvas.height,t=2*Math.atan(Math.tan(.5*t)*e)),r.camera.frustum.fov=t,i=o.toArray(),e=T(n.getPitch()),t=this._calcDistance(n),o=new s.Cartographic(T(i[0]),T(i[1])),r.globe&&(i=r.globe.getHeight(o),o.height=i||0),o=s.Ellipsoid.WGS84.cartographicToCartesian(o),n={pitch:e-Math.PI/2,heading:T(n.getBearing()),roll:void 0},r.camera.setView({destination:o,orientation:n}),r.camera.moveBackward(t))},O.prototype._calcDistance=function(e){var t=this.scene.camera.frustum.fov,i=e.getCenter(),n=e.locateByPoint(i,-e.width/2,0),i=e.locateByPoint(i,e.width/2,0);return e.computeLength(i,n)/2/Math.tan(t/2)},O);function O(){return f(this,O),l(this,w.apply(this,arguments))}function T(e){return e*Math.PI/180}y.registerRenderer("canvas",t),e.CesiumLayer=y,e.Primitive=o,e.Cesium3DTileset=p,Object.defineProperty(e,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.cesium v0.0.0, requires maptalks@<2.0.0.")});